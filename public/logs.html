<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Logs</title>
    <script>
        function showMessage(message) {
            const messages = document.querySelector('#messages');
            messages.textContent += `\n${message}`;
            messages.scrollTop = messages.scrollHeight;
        }

        function handleResponse(response) {
            return response.ok
                ? response.json().then((data) => JSON.stringify(data, null, 2))
                : Promise.reject(new Error('Unexpected response'));
        }

        function NewWebsocket() {
            const onMessages = [],
                onOpens = [],
                onCloses = [],
                onErrors = []

            let ws = new WebSocket(`ws://${location.host}`);
            let interval

            ws.onerror = function () {
                showMessage('WebSocket error');
                onErrors.forEach((fn) => fn())
            };

            ws.onmessage = function (event) {
                onMessages.forEach((fn) => fn(event.data))
            }

            ws.onopen = function () {
                interval = setInterval(function ping() {
                    ws.send('pong')
                }, 30000);
                onOpens.forEach((fn) => fn())
            };

            ws.onclose = function () {
                clearInterval(interval)
                onCloses.forEach((fn) => fn())
                ws = null;
            };

            return {
                send: function (msg) {
                    ws.send(msg)
                },
                addListener(even, fn) {
                    if (even === "message") {
                        onMessages.push(fn)
                    } else if (even === "open") {
                        onOpens.push(fn)
                    } else if (even === "close") {
                        onCloses.push(fn)
                    } else if (even === "error") {
                        onErrors.push(fn)
                    } else {
                        console.error("unknown event")
                    }
                }
            };
        }

        fetch('/login', {method: 'POST', credentials: 'same-origin'})
            .then(handleResponse)
            // .then(showMessage)
            .then(() => {
                const ws = NewWebsocket()
                ws.addListener('message', function (d) {
                    showMessage(d)
                })
                ws.addListener("open",()=>{
                    showMessage('WebSocket connection established');
                })
                ws.addListener("close",()=>{
                    showMessage('WebSocket connection closed');
                })
            })
            .catch(function (err) {
                showMessage(err.message);
            });

    </script>
</head>
<body>
<pre id="messages" style="height: 800px; overflow: scroll"></pre>
</body>
</html>
